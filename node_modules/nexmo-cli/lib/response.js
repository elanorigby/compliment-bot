'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _colors = require('colors');

var _colors2 = _interopRequireDefault(_colors);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Response = function () {
  function Response(validator, emitter) {
    _classCallCheck(this, Response);

    this.emitter = emitter;
    this.validator = validator;
  }

  _createClass(Response, [{
    key: 'accountSetup',
    value: function accountSetup(config, key, secret, flags) {
      var _this = this;

      return function (error, response) {
        _this.validator.response(error, response);
        config.putAndSave({
          'credentials': {
            'api_key': key,
            'api_secret': secret
          }
        }, flags.local);
      };
    }
  }, {
    key: 'accountInfo',
    value: function accountInfo(client) {
      this.emitter.log('API Key:    ' + client.credentials.apiKey + '\nAPI Secret: ' + client.credentials.apiSecret);
    }
  }, {
    key: 'accountBalance',
    value: function accountBalance(error, response) {
      this.validator.response(error, response);
      this.emitter.log(Number(response.value.toFixed(2)) + ' EUR', response.value + ' EUR');
    }

    // Pricing

  }, {
    key: 'priceSms',
    value: function priceSms(error, response) {
      this.validator.response(error, response);
      this.emitter.log(response.price + ' EUR');
    }
  }, {
    key: 'priceVoice',
    value: function priceVoice(error, response) {
      this.validator.response(error, response);
      this.emitter.log(response.price + ' EUR');
    }
  }, {
    key: 'priceCountry',
    value: function priceCountry(error, response) {
      this.validator.response(error, response);
      if (response.networks && this.emitter.amplified) {
        this.emitter.table(response.networks, ['network', 'mtPrice'], ['network', 'mtPrice']);
      } else if (response.mt) {
        var price = this._maxPrice(response);
        this.emitter.log(price + ' EUR');
      } else {
        this.emitter.log('No price found');
      }
    }
  }, {
    key: '_maxPrice',
    value: function _maxPrice(response) {
      var prices = response.networks.map(function (network) {
        return parseFloat(network.mtPrice);
      });
      prices.push(parseFloat(response.mt));
      return Math.max.apply(null, prices);
    }

    // numbers

  }, {
    key: 'numbersList',
    value: function numbersList(flags) {
      var _this2 = this;

      return function (error, response) {
        _this2.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          _this2.emitter.pagination(flags, response);
          _this2.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'type', 'features', 'voiceCallbackType', 'voiceCallbackValue', 'moHttpUrl', 'voiceStatusCallbackUrl']);
        } else {
          _this2.emitter.warn('No numbers');
        }
      };
    }
  }, {
    key: 'numberSearch',
    value: function numberSearch(flags) {
      var _this3 = this;

      return function (error, response) {
        _this3.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          _this3.emitter.pagination(flags, response);
          _this3.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'cost', 'type', 'features']);
        } else {
          _this3.emitter.warn('No numbers');
        }
      };
    }
  }, {
    key: 'numberBuyFromNumber',
    value: function numberBuyFromNumber(number) {
      var _this4 = this;

      return function (error, response) {
        _this4.validator.response(error, response);
        _this4.emitter.log('Number purchased: ' + number);
      };
    }
  }, {
    key: 'numberBuyFromPattern',
    value: function numberBuyFromPattern(callback) {
      var _this5 = this;

      return function (error, response) {
        _this5.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          callback(response.numbers[0].msisdn);
        } else {
          _this5.emitter.error('No numbers match your search');
        }
      };
    }
  }, {
    key: 'numberCancel',
    value: function numberCancel(number) {
      var _this6 = this;

      return function (error, response) {
        _this6.validator.response(error, response);
        _this6.emitter.log('Number cancelled: ' + number);
      };
    }
  }, {
    key: 'numberInsight',
    value: function numberInsight(callback) {
      var _this7 = this;

      return function (error, response) {
        _this7.validator.response(error, response);
        callback(response);
      };
    }

    // applications

  }, {
    key: 'applicationsList',
    value: function applicationsList(flags) {
      var _this8 = this;

      return function (error, response) {
        _this8.validator.response(error, response);
        if (response._embedded && response._embedded.applications && response._embedded.applications.length > 0) {
          _this8.emitter.pagination(flags, response);
          _this8.emitter.table(response._embedded.applications, ['id', 'name'], ['id', 'name']);
        } else {
          _this8.emitter.warn('No applications');
        }
      };
    }
  }, {
    key: 'applicationCreate',
    value: function applicationCreate(flags) {
      var _this9 = this;

      return function (error, response) {
        _this9.validator.response(error, response);
        _this9.emitter.list('Application created: ' + response.id, response);
        _this9._writeKey(flags.keyfile, response.keys.private_key);
      };
    }
  }, {
    key: 'applicationShow',
    value: function applicationShow(error, response) {
      this.validator.response(error, response);
      this.emitter.list(null, response);
    }
  }, {
    key: 'applicationUpdate',
    value: function applicationUpdate(error, response) {
      this.validator.response(error, response);
      this.emitter.list('Application updated: ' + response.id, response);
    }
  }, {
    key: 'applicationDelete',
    value: function applicationDelete(error, response) {
      this.validator.response(error, response);
      this.emitter.log('Application deleted');
    }
  }, {
    key: 'applicationNumbers',
    value: function applicationNumbers(app_id, flags) {
      var _this10 = this;

      return function (error, response) {
        _this10.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          response.numbers = response.numbers.filter(function (number) {
            return number.voiceCallbackValue == app_id;
          });

          _this10.emitter.pagination(flags, response);
          _this10.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'type', 'features', 'voiceCallbackType', 'voiceCallbackValue', 'moHttpUrl', 'voiceStatusCallbackUrl']);
        } else {
          _this10.emitter.warn('No numbers');
        }
      };
    }

    // links

  }, {
    key: 'numberUpdate',
    value: function numberUpdate(error, response) {
      this.validator.response(error, response);
      this.emitter.log('Number updated');
    }

    // insight

  }, {
    key: 'insightBasic',
    value: function insightBasic(error, response) {
      this.validator.response(error, response);
      this.emitter.list(response.international_format_number + ' | ' + response.country_code, response);
    }
  }, {
    key: 'insightStandard',
    value: function insightStandard(error, response) {
      this.validator.response(error, response);
      this.emitter.list(response.international_format_number + ' | ' + response.country_code + ' | ' + response.current_carrier.name, response);
    }
  }, {
    key: '_writeKey',
    value: function _writeKey(keyfile, private_key) {
      var _this11 = this;

      if (keyfile) {
        _fs2.default.writeFile(keyfile, private_key, function (error) {
          if (error) {
            _this11.emitter.warn(error.message);
            _this11._promptKey(private_key);
          } else {
            _this11.emitter.log('Private Key saved to: ' + keyfile);
          }
        });
      } else {
        this._promptKey(private_key);
      }
    }
  }, {
    key: '_promptKey',
    value: function _promptKey(private_key) {
      this.emitter.log('\nPrivate Key:\n');
      this.emitter.log(_colors2.default.red.bgWhite(private_key + '\n'));
      this.emitter.log('WARNING: You should save this key somewhere safe and secure now, it will not be provided again.');
    }

    // sending messages

  }, {
    key: 'sendSms',
    value: function sendSms(error, response) {
      this.validator.response(error, response);
      var message = response.messages[0];
      this.emitter.log('Message sent to:   ' + message.to + '\nRemaining balance: ' + message['remaining-balance'] + ' EUR\nMessage price:     ' + message['message-price'] + ' EUR');
    }

    // JWT

  }, {
    key: 'generateJwt',
    value: function generateJwt(error, token) {
      this.validator.response(error, token);
      this.emitter.log('' + token, 'JWT:   ' + token);
    }
  }]);

  return Response;
}();

exports.default = Response;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXNwb25zZS5qcyJdLCJuYW1lcyI6WyJSZXNwb25zZSIsInZhbGlkYXRvciIsImVtaXR0ZXIiLCJjb25maWciLCJrZXkiLCJzZWNyZXQiLCJmbGFncyIsImVycm9yIiwicmVzcG9uc2UiLCJwdXRBbmRTYXZlIiwibG9jYWwiLCJjbGllbnQiLCJsb2ciLCJjcmVkZW50aWFscyIsImFwaUtleSIsImFwaVNlY3JldCIsIk51bWJlciIsInZhbHVlIiwidG9GaXhlZCIsInByaWNlIiwibmV0d29ya3MiLCJhbXBsaWZpZWQiLCJ0YWJsZSIsIm10IiwiX21heFByaWNlIiwicHJpY2VzIiwibWFwIiwibmV0d29yayIsInBhcnNlRmxvYXQiLCJtdFByaWNlIiwicHVzaCIsIk1hdGgiLCJtYXgiLCJhcHBseSIsIm51bWJlcnMiLCJsZW5ndGgiLCJwYWdpbmF0aW9uIiwid2FybiIsIm51bWJlciIsImNhbGxiYWNrIiwibXNpc2RuIiwiX2VtYmVkZGVkIiwiYXBwbGljYXRpb25zIiwibGlzdCIsImlkIiwiX3dyaXRlS2V5Iiwia2V5ZmlsZSIsImtleXMiLCJwcml2YXRlX2tleSIsImFwcF9pZCIsImZpbHRlciIsInZvaWNlQ2FsbGJhY2tWYWx1ZSIsImludGVybmF0aW9uYWxfZm9ybWF0X251bWJlciIsImNvdW50cnlfY29kZSIsImN1cnJlbnRfY2FycmllciIsIm5hbWUiLCJmcyIsIndyaXRlRmlsZSIsIm1lc3NhZ2UiLCJfcHJvbXB0S2V5IiwiY29sb3JzIiwicmVkIiwiYmdXaGl0ZSIsIm1lc3NhZ2VzIiwidG8iLCJ0b2tlbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7Ozs7OztJQUVNQSxRO0FBQ0osb0JBQVlDLFNBQVosRUFBdUJDLE9BQXZCLEVBQWdDO0FBQUE7O0FBQzlCLFNBQUtBLE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtELFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0Q7Ozs7aUNBRVlFLE0sRUFBUUMsRyxFQUFLQyxNLEVB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QS9DLDZCQUNpQk4sUUFBUSxtQkFBUixDQURqQixpQ0FFaUJBLFFBQVEsZUFBUixDQUZqQjtBQUdEOztBQUVEOzs7O2dDQUVZbkQsSyxFQUFPMEQsSyxFQUFPO0FBQ3hCLFdBQUtoRSxTQUFMLENBQWVPLFFBQWYsQ0FBd0JELEtBQXhCLEVBQStCMEQsS0FBL0I7QUFDQSxXQUFLL0QsT0FBTCxDQUFhVSxHQUFiLE1BQW9CcUQsS0FBcEIsY0FBdUNBLEtBQXZDO0FBQ0Q7Ozs7OztrQkFHWWpFLFEiLCJmaWxlIjoicmVzcG9uc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY29sb3JzIGZyb20gJ2NvbG9ycyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5jbGFzcyBSZXNwb25zZSB7XG4gIGNvbnN0cnVjdG9yKHZhbGlkYXRvciwgZW1pdHRlcikge1xuICAgIHRoaXMuZW1pdHRlciA9IGVtaXR0ZXI7XG4gICAgdGhpcy52YWxpZGF0b3IgPSB2YWxpZGF0b3I7XG4gIH1cblxuICBhY2NvdW50U2V0dXAoY29uZmlnLCBrZXksIHNlY3JldCwgZmxhZ3MpIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIGNvbmZpZy5wdXRBbmRTYXZlKHtcbiAgICAgICAgJ2NyZWRlbnRpYWxzJzoge1xuICAgICAgICAgICdhcGlfa2V5Jzoga2V5LFxuICAgICAgICAgICdhcGlfc2VjcmV0Jzogc2VjcmV0XG4gICAgICAgIH1cbiAgICAgIH0sIGZsYWdzLmxvY2FsKTtcbiAgICB9O1xuICB9XG5cbiAgYWNjb3VudEluZm8oY2xpZW50KSB7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhcbmBBUEkgS2V5OiAgICAke2NsaWVudC5jcmVkZW50aWFscy5hcGlLZXl9XG5BUEkgU2VjcmV0OiAke2NsaWVudC5jcmVkZW50aWFscy5hcGlTZWNyZXR9YFxuICAgICk7XG4gIH1cblxuICBhY2NvdW50QmFsYW5jZShlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coXG4gICAgICBgJHtOdW1iZXIoKHJlc3BvbnNlLnZhbHVlKS50b0ZpeGVkKDIpKX0gRVVSYCxcbiAgICAgIGAke3Jlc3BvbnNlLnZhbHVlfSBFVVJgXG4gICAgKTtcbiAgfVxuXG4gIC8vIFByaWNpbmdcblxuICBwcmljZVNtcyhlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coYCR7cmVzcG9uc2UucHJpY2V9IEVVUmApO1xuICB9XG5cbiAgcHJpY2VWb2ljZShlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coYCR7cmVzcG9uc2UucHJpY2V9IEVVUmApO1xuICB9XG5cbiAgcHJpY2VDb3VudHJ5KGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgaWYgKHJlc3BvbnNlLm5ldHdvcmtzICYmIHRoaXMuZW1pdHRlci5hbXBsaWZpZWQpIHtcbiAgICAgIHRoaXMuZW1pdHRlci50YWJsZShyZXNwb25zZS5uZXR3b3JrcywgWyduZXR3b3JrJywgJ210UHJpY2UnXSwgWyduZXR3b3JrJywgJ210UHJpY2UnXSk7XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5tdCkge1xuICAgICAgbGV0IHByaWNlID0gdGhpcy5fbWF4UHJpY2UocmVzcG9uc2UpO1xuICAgICAgdGhpcy5lbWl0dGVyLmxvZyhgJHtwcmljZX0gRVVSYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZW1pdHRlci5sb2coJ05vIHByaWNlIGZvdW5kJyk7XG4gICAgfVxuICB9XG5cbiAgX21heFByaWNlKHJlc3BvbnNlKSB7XG4gICAgbGV0IHByaWNlcyA9IHJlc3BvbnNlLm5ldHdvcmtzLm1hcCgobmV0d29yaykgPT4ge1xuICAgICAgcmV0dXJuIHBhcnNlRmxvYXQobmV0d29yay5tdFByaWNlKTtcbiAgICB9KTtcbiAgICBwcmljZXMucHVzaChwYXJzZUZsb2F0KHJlc3BvbnNlLm10KSk7XG4gICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIHByaWNlcyk7XG4gIH1cblxuICAvLyBudW1iZXJzXG5cbiAgbnVtYmVyc0xpc3QoZmxhZ3MpIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIGlmIChyZXNwb25zZS5udW1iZXJzICYmIHJlc3BvbnNlLm51bWJlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmVtaXR0ZXIucGFnaW5hdGlvbihmbGFncywgcmVzcG9uc2UpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIudGFibGUocmVzcG9uc2UubnVtYmVycywgWydtc2lzZG4nXSwgWydtc2lzZG4nLCAnY291bnRyeScsICd0eXBlJywgJ2ZlYXR1cmVzJywgJ3ZvaWNlQ2FsbGJhY2tUeXBlJywgJ3ZvaWNlQ2FsbGJhY2tWYWx1ZScsICdtb0h0dHBVcmwnLCAndm9pY2VTdGF0dXNDYWxsYmFja1VybCddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci53YXJuKCdObyBudW1iZXJzJyk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIG51bWJlclNlYXJjaChmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgaWYgKHJlc3BvbnNlLm51bWJlcnMgJiYgcmVzcG9uc2UubnVtYmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5wYWdpbmF0aW9uKGZsYWdzLCByZXNwb25zZSk7XG4gICAgICAgIHRoaXMuZW1pdHRlci50YWJsZShyZXNwb25zZS5udW1iZXJzLCBbJ21zaXNkbiddLCBbJ21zaXNkbicsICdjb3VudHJ5JywgJ2Nvc3QnLCAndHlwZScsICdmZWF0dXJlcyddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci53YXJuKCdObyBudW1iZXJzJyk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIG51bWJlckJ1eUZyb21OdW1iZXIobnVtYmVyKSB7XG4gICAgcmV0dXJuIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgICB0aGlzLmVtaXR0ZXIubG9nKGBOdW1iZXIgcHVyY2hhc2VkOiAke251bWJlcn1gKTtcbiAgICB9O1xuICB9XG5cbiAgbnVtYmVyQnV5RnJvbVBhdHRlcm4oY2FsbGJhY2spIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIGlmIChyZXNwb25zZS5udW1iZXJzICYmIHJlc3BvbnNlLm51bWJlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBjYWxsYmFjayhyZXNwb25zZS5udW1iZXJzWzBdLm1zaXNkbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmVtaXR0ZXIuZXJyb3IoJ05vIG51bWJlcnMgbWF0Y2ggeW91ciBzZWFyY2gnKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgbnVtYmVyQ2FuY2VsKG51bWJlcikge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgdGhpcy5lbWl0dGVyLmxvZyhgTnVtYmVyIGNhbmNlbGxlZDogJHtudW1iZXJ9YCk7XG4gICAgfTtcbiAgfVxuXG4gIG51bWJlckluc2lnaHQoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIGNhbGxiYWNrKHJlc3BvbnNlKTtcbiAgICB9O1xuICB9XG5cbiAgLy8gYXBwbGljYXRpb25zXG5cbiAgYXBwbGljYXRpb25zTGlzdChmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgaWYgKHJlc3BvbnNlLl9lbWJlZGRlZCAmJiByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zICYmIHJlc3BvbnNlLl9lbWJlZGRlZC5hcHBsaWNhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmVtaXR0ZXIucGFnaW5hdGlvbihmbGFncywgcmVzcG9uc2UpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIudGFibGUocmVzcG9uc2UuX2VtYmVkZGVkLmFwcGxpY2F0aW9ucywgWydpZCcsICduYW1lJ10sIFsnaWQnLCAnbmFtZSddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci53YXJuKCdObyBhcHBsaWNhdGlvbnMnKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgYXBwbGljYXRpb25DcmVhdGUoZmxhZ3MpIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIHRoaXMuZW1pdHRlci5saXN0KGBBcHBsaWNhdGlvbiBjcmVhdGVkOiAke3Jlc3BvbnNlLmlkfWAsIHJlc3BvbnNlKTtcbiAgICAgIHRoaXMuX3dyaXRlS2V5KGZsYWdzLmtleWZpbGUsIHJlc3BvbnNlLmtleXMucHJpdmF0ZV9rZXkpO1xuICAgIH07XG4gIH1cblxuICBhcHBsaWNhdGlvblNob3coZXJyb3IsIHJlc3BvbnNlKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB0aGlzLmVtaXR0ZXIubGlzdChudWxsLCByZXNwb25zZSk7XG4gIH1cblxuICBhcHBsaWNhdGlvblVwZGF0ZShlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5saXN0KGBBcHBsaWNhdGlvbiB1cGRhdGVkOiAke3Jlc3BvbnNlLmlkfWAsIHJlc3BvbnNlKTtcbiAgfVxuXG4gIGFwcGxpY2F0aW9uRGVsZXRlKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZygnQXBwbGljYXRpb24gZGVsZXRlZCcpO1xuICB9XG5cbiAgYXBwbGljYXRpb25OdW1iZXJzKGFwcF9pZCwgZmxhZ3MpIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIGlmIChyZXNwb25zZS5udW1iZXJzICYmIHJlc3BvbnNlLm51bWJlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXNwb25zZS5udW1iZXJzID0gcmVzcG9uc2UubnVtYmVycy5maWx0ZXIoKG51bWJlcikgPT4ge1xuICAgICAgICAgIHJldHVybiBudW1iZXIudm9pY2VDYWxsYmFja1ZhbHVlID09IGFwcF9pZDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5lbWl0dGVyLnBhZ2luYXRpb24oZmxhZ3MsIHJlc3BvbnNlKTtcbiAgICAgICAgdGhpcy5lbWl0dGVyLnRhYmxlKHJlc3BvbnNlLm51bWJlcnMsIFsnbXNpc2RuJ10sIFsnbXNpc2RuJywgJ2NvdW50cnknLCAndHlwZScsICdmZWF0dXJlcycsICd2b2ljZUNhbGxiYWNrVHlwZScsICd2b2ljZUNhbGxiYWNrVmFsdWUnLCAnbW9IdHRwVXJsJywgJ3ZvaWNlU3RhdHVzQ2FsbGJhY2tVcmwnXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmVtaXR0ZXIud2FybignTm8gbnVtYmVycycpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICAvLyBsaW5rc1xuXG4gIG51bWJlclVwZGF0ZShlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coJ051bWJlciB1cGRhdGVkJyk7XG4gIH1cblxuICAvLyBpbnNpZ2h0XG5cbiAgaW5zaWdodEJhc2ljKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxpc3QoYCR7cmVzcG9uc2UuaW50ZXJuYXRpb25hbF9mb3JtYXRfbnVtYmVyfSB8ICR7cmVzcG9uc2UuY291bnRyeV9jb2RlfWAsIHJlc3BvbnNlKTtcbiAgfVxuXG4gIGluc2lnaHRTdGFuZGFyZChlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5saXN0KGAke3Jlc3BvbnNlLmludGVybmF0aW9uYWxfZm9ybWF0X251bWJlcn0gfCAke3Jlc3BvbnNlLmNvdW50cnlfY29kZX0gfCAke3Jlc3BvbnNlLmN1cnJlbnRfY2Fycmllci5uYW1lfWAsIHJlc3BvbnNlKTtcbiAgfVxuXG4gIF93cml0ZUtleShrZXlmaWxlLCBwcml2YXRlX2tleSkge1xuICAgIGlmIChrZXlmaWxlKSB7XG4gICAgICBmcy53cml0ZUZpbGUoa2V5ZmlsZSwgcHJpdmF0ZV9rZXksIChlcnJvcikgPT4ge1xuICAgICAgICBpZihlcnJvcikge1xuICAgICAgICAgIHRoaXMuZW1pdHRlci53YXJuKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgIHRoaXMuX3Byb21wdEtleShwcml2YXRlX2tleSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5lbWl0dGVyLmxvZyhgUHJpdmF0ZSBLZXkgc2F2ZWQgdG86ICR7a2V5ZmlsZX1gKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3Byb21wdEtleShwcml2YXRlX2tleSk7XG4gICAgfVxuICB9XG5cbiAgX3Byb21wdEtleShwcml2YXRlX2tleSkge1xuICAgIHRoaXMuZW1pdHRlci5sb2coJ1xcblByaXZhdGUgS2V5OlxcbicpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coY29sb3JzLnJlZC5iZ1doaXRlKGAke3ByaXZhdGVfa2V5fVxcbmApKTtcbiAgICB0aGlzLmVtaXR0ZXIubG9nKCdXQVJOSU5HOiBZb3Ugc2hvdWxkIHNhdmUgdGhpcyBrZXkgc29tZXdoZXJlIHNhZmUgYW5kIHNlY3VyZSBub3csIGl0IHdpbGwgbm90IGJlIHByb3ZpZGVkIGFnYWluLicpO1xuICB9XG5cbiAgLy8gc2VuZGluZyBtZXNzYWdlc1xuXG4gIHNlbmRTbXMoZXJyb3IsIHJlc3BvbnNlKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICBjb25zdCBtZXNzYWdlID0gcmVzcG9uc2UubWVzc2FnZXNbMF07XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhgTWVzc2FnZSBzZW50IHRvOiAgICR7bWVzc2FnZS50b31cblJlbWFpbmluZyBiYWxhbmNlOiAke21lc3NhZ2VbJ3JlbWFpbmluZy1iYWxhbmNlJ119IEVVUlxuTWVzc2FnZSBwcmljZTogICAgICR7bWVzc2FnZVsnbWVzc2FnZS1wcmljZSddfSBFVVJgKTtcbiAgfVxuXG4gIC8vIEpXVFxuXG4gIGdlbmVyYXRlSnd0KGVycm9yLCB0b2tlbikge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCB0b2tlbik7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhgJHt0b2tlbn1gLCBgSldUOiAgICR7dG9rZW59YCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVzcG9uc2U7XG4iXX0=